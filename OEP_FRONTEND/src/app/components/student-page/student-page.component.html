<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand">Online Exam Portal</a>
    <div class="d-flex ms-auto">
      <div class="dropdown">
        <a class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-person-fill me-2"></i> <strong>{{ loggedInUsername || 'Student' }}</strong>
        </a>
        <ul class="dropdown-menu dropdown-menu-dark text-small shadow dropdown-menu-end">
          <li>
            <a class="dropdown-item" [class.active]="selectedOption === 'profile'" (click)="selectOption('profile')">
              <i class="bi bi-person-circle me-2"></i>
              Profile
            </a>
          </li>
          <li>
            <hr class="dropdown-divider">
          </li>
          <div class="text-center">
            <button class="btn btn-danger border text-white px-2 py-2" (click)="logout()">
              <i class="bi bi-box-arrow-right me-2"></i> Logout
            </button>
          </div>
        </ul>
      </div>
    </div>
  </div>
</nav>

<div class="d-flex flex-nowrap bg-light mt-5">
  <div class="d-flex flex-column flex-shrink-0 p-3 text-bg-dark" style="width: 280px; min-height: calc(100vh - 56px); overflow-y: hidden;">
    <div class="mb-3 p-2">
      <h4 class="fw-bold text-success">
        <i class="bi bi-stars me-2"></i> Hey {{ loggedInUsername || 'Student' }}!!
      </h4>
      <h6 class="text-white">Explore available exams below!</h6>
    </div>

    <ul class="nav nav-pills flex-column mb-auto">
      <li class="nav-item">
        <a class="nav-link text-white" aria-current="page" [class.active]="selectedOption === 'availableExams'" (click)="selectOption('availableExams')">
          <i class="bi bi-journals me-2"></i>
          Exams
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link text-white" [class.active]="selectedOption === 'attendExam'" (click)="selectOption('attendExam')">
          <i class="bi bi-play-circle-fill me-2"></i>
          Attend Exam
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link text-white" [class.active]="selectedOption === 'viewReport'" (click)="selectOption('viewReport')">
          <i class="bi bi-file-earmark-text-fill me-2"></i>
          Get Report
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link text-white" [class.active]="selectedOption === 'leaderboard'" (click)="selectOption('leaderboard')">
          <i class="bi bi-trophy-fill me-2"></i>
          View Leaderboard
        </a>
      </li>
    </ul>
    <hr class="text-secondary">
  </div>
  <main class="flex-grow-1 p-3 bg-light" style="overflow-y: auto; padding-bottom: 60px;">
    <div *ngIf="selectedOption === 'availableExams'">
      <h3 class="mb-4">Available Exams</h3>
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        <div class="col" *ngFor="let exam of availableExams">
          <div class="card h-100 shadow-sm border-primary">
            <div class="card-body p-3">
              <h5 class="card-title text-primary">{{ exam.title }}</h5>
              <p class="card-text text-muted small">{{ exam.description || 'No description available.' }}</p>
              <div class="d-flex justify-content-between">
                <span class="text-muted small">Marks: {{ exam.totalMarks }}</span>
                <span class="text-muted small">Duration: {{ exam.duration }} mins</span>
              </div>
            </div>
          </div>
        </div>
        <div *ngIf="availableExams.length === 0" class="col-12">
          <p class="lead text-muted">No exams are currently available.</p>
        </div>
      </div>
    </div>

    <div *ngIf="selectedOption === 'attendExam'">
      <h3 class="mb-4">Attend Exam</h3>
      <p class="lead">Select an exam to attend.</p>

      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        <div class="col" *ngFor="let exam of availableExams">
          <div class="card h-100 shadow-sm border-primary">
            <div class="card-body p-3">
              <h5 class="card-title text-primary">{{ exam.title }}</h5>
              <p class="card-text text-muted small">{{ exam.description || 'No description available.' }}</p>
              <div class="d-flex justify-content-between">
                <span class="text-muted small">Marks: {{ exam.totalMarks }}</span>
                <span class="text-muted small">Duration: {{ exam.duration }} mins</span>
                <button class="btn btn-primary" (click)="goToAttendExam(exam.examId, loggedInUsername)">Attend Exam</button>
              </div>
            </div>
          </div>
        </div>
        <div *ngIf="availableExams.length === 0" class="col-12">
          <p class="lead text-muted">No exams are currently available.</p>
        </div>
      </div>
    </div>
    <div *ngIf="selectedOption === 'profile' && userProfile">
      <h3 class="mb-4">User Profile</h3>
      <div class="card shadow-sm border-primary">
        <div class="card-body">
          <h5 class="card-title text-primary">{{ userProfile.userName }}</h5>
          <p class="card-text"><strong>Email:</strong> {{ userProfile.email }}</p>
          <p class="card-text"><strong>Roles:</strong> {{ userProfile.roles.join(', ') }}</p>
          <p class="card-text"><strong>User ID:</strong> {{ userProfile.userId }}</p>
          <button class="btn btn-primary mt-3" (click)="showUpdatePasswordForm()">Update Password</button>
        </div>
      </div>
    </div>
    <div *ngIf="showPasswordForm" class="modal-overlay">
      <div class="modal-content">
        <h3>Update Password</h3>
        <div class="mb-3">
          <label for="oldPassword" class="form-label">Old Password</label>
          <input type="password" class="form-control" id="oldPassword" [(ngModel)]="oldPassword">
        </div>
        <div class="mb-3">
          <label for="newPassword" class="form-label">New Password</label>
          <input type="password" class="form-control" id="newPassword" [(ngModel)]="newPassword">
        </div>
        <div class="mb-3">
          <label for="confirmPassword" class="form-label">Confirm Password</label>
          <input type="password" class="form-control" id="confirmPassword" [(ngModel)]="confirmPassword">
        </div>
        <button class="btn btn-primary" (click)="updatePassword()">Update</button>
        <button class="btn btn-secondary" (click)="closePasswordForm()">Cancel</button>
      </div>
    </div>
    
    <div *ngIf="selectedOption === 'profile' && !userProfile">
      <p class="lead text-muted">Loading profile information...</p>
    </div>
    <div *ngIf="selectedOption === 'viewReport'">
      <h3 class="mb-4">Get Report</h3>
      <p class="lead">Here are your exam reports.</p>
      <div *ngFor="let report of reports" class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">Exam ID: {{ report.examId }}</h5>
          <p class="card-text">Correct Answers: {{ report.correctAnswers }} / {{ report.totalQuestions }}</p>
          <p class="card-text">Score: {{ report.score }}</p>
          <p class="card-text">Percentage: {{ report.percentage }}%</p>
          <p class="card-text">Feedback: {{ report.feedback || 'No feedback available.' }}</p>
        </div>
      </div>
      <div *ngIf="reports.length === 0 && loggedInUsername">
        <p>No reports available.</p>
      </div>
      <div *ngIf="!loggedInUsername">
        <p>Please login to view reports</p>
      </div>
    </div>
    <div *ngIf="selectedOption === 'leaderboard'" class="container mt-4">
      <h3 class="mb-4">View Leaderboard</h3>
      <p class="badge text-wrap bg-success">Check the leaderboard to see how you rank among other students.</p>

      <div class="mb-3">
        <label for="examSelect" class="form-label">Select Exam:</label>
        <select class="form-select" id="examSelect" [(ngModel)]="selectedExamId" (change)="loadLeaderboard()">
          <option [value]="null">Select an Exam</option>
          <option *ngFor="let exam of availableExams" [value]="exam.examId">{{ exam.title }}</option>
        </select>
      </div>

      <div *ngIf="leaderboard.length > 0">
        <table class="table table-striped table-hover table-bordered">
          <thead class="table-dark">
            <tr>
              <th scope="col">Position</th>
              <th scope="col">Username</th>
              <th scope="col">Marks</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let entry of leaderboard">
              <td>{{ entry.position }}</td>
              <td>{{ entry.username }}</td>
              <td>{{ entry.marks }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div *ngIf="leaderboard.length === 0 && selectedExamId !== null" class="alert alert-info" role="alert">
        No leaderboard data available for the selected exam.
      </div>
    </div>
    <div *ngIf="!selectedOption || selectedOption === 'dashboard'">
      <h3 class="mb-4">Student Dashboard</h3>
      <p class="lead">Welcome to your student portal!</p>
      <p>Use the sidebar to navigate to different sections.</p>
    </div>
  </main>
</div>